name: Deploy and Configure Morio

on:
  workflow_dispatch: # Allow manual triggering for a test
  issue_comment:
    types: [created] # Trigger when a comment is created on a PR

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.event.issue.pull_request.head.sha }}

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Initialize Comment
        id: create_comment
        run: |
          # Fetch the latest comment on the pull request
          COMMENT_RESPONSE=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments)
          
          # Extract the username and comment link (assuming the first comment is relevant)
          USERNAME=$(echo "$COMMENT_RESPONSE" | jq -r '.[0].user.login')
          LINK_TO_COMMENT=$(echo "$COMMENT_RESPONSE" | jq -r '.[0].html_url')
          
          # Construct the comment body
          COMMENT_BODY="As requested by @$USERNAME in [this comment]($LINK_TO_COMMENT) we will test this pull request. 
      To do so, we will provision ephemeral infrastructure and then run integration tests.

      This will take a while, but we will report back here to keep you updated:"

          # Post the comment to the PR
          POST_COMMENT_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"body\": \"$COMMENT_BODY\"}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments)
          
          # Extract the comment ID for later use (if needed)
          COMMENT_ID=$(echo "$POST_COMMENT_RESPONSE" | jq -r .id)
          echo "COMMENT_ID=$COMMENT_ID" >> $GITHUB_ENV

      - name: Check if Comment Matches Deploy Key and User is Allowed
        id: check_trigger
        run: |
          echo "Checking deploy key and allowed users..."

          # Initialize match to false
          echo "match=false" >> $GITHUB_ENV

          # Ensure the event is triggered for a pull request
          if [[ "${{ github.event.issue.pull_request }}" == "" ]]; then
            echo "Not a pull request. Proceeding with PR_ID=32 for manual testing."
          else
            ALLOWED_USERS=$(cat allowed_users.txt)
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENT_USER="${{ github.event.comment.user.login }}"
            ITEST_DEPLOY_TRIGGER="${{ vars.ITEST_DEPLOY_TRIGGER }}"

            if [[ "$COMMENT_BODY" == *"$ITEST_DEPLOY_TRIGGER"* && "$ALLOWED_USERS" == *"$COMMENT_USER"* ]]; then
              echo "match=true" >> $GITHUB_ENV
            fi
          fi
        env:
          ITEST_DEPLOY_TRIGGER: ${{ vars.ITEST_DEPLOY_TRIGGER }}

      - name: Exit if Not Triggered by Allowed User or Matching Deploy Key
        if: ${{ env.match != 'true' }}
        run: echo "Comment does not match deploy key or user is not allowed. Exiting..."
        continue-on-error: true

      - name: Set PR ID as Environment Variable
        run: |
          if [ "${{ github.event.pull_request.number }}" ]; then
            echo "PR_ID=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          else
            echo "PR_ID=32" >> $GITHUB_ENV
          fi

      - name: Configure AWS CLI
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set region eu-central-1
          aws configure set output json

      - name: Install Python Dependencies for Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install --upgrade pip
          pip3 install boto3 botocore

      - name: Verify Python Version
        run: python3 --version

      - name: Verify boto3 and botocore installation
        run: |
          python3 -c "import boto3; print(boto3.__version__)"
          python3 -c "import botocore; print(botocore.__version__)"

      - name: Install Ansible
        run: sudo apt-get install -y ansible

      - name: Create Inventory File
        run: |
          echo "[localhost]" > inventory
          echo "127.0.0.1 ansible_python_interpreter=$(which python3)" >> inventory

      - name: Install required Ansible collections
        run: ansible-galaxy collection install amazon.aws community.general

      - name: Install Node.js dependencies
        run: |
          npm install
          npm install dotenv

      - name: Generate SSH Key Pair
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
          echo "SSH Key Pair generated and stored in ~/.ssh/id_rsa"

      - name: Run ideploy (Deploy to the environment)
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Deploy to Environment"
            STATUS: "Pending"

          # Run the deployment command
          if npm run ideploy; then
            # If the deployment is successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Deploy to Environment"
              STATUS: "Success"
          else
            # If the deployment fails, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Deploy to Environment"
              STATUS: "Fail"
            exit 1  # Exit the job if it fails
          fi
        env:
          PR_ID: ${{ env.PR_ID }}
          ITEST_AWS_SUBNET_ID: ${{ secrets.ITEST_AWS_SUBNET_ID }}
          ITEST_AWS_SECURITY_GROUP_ID: ${{ secrets.ITEST_AWS_SECURITY_GROUP_ID }}
          ITEST_AWS_ROUTE53_ZONE_ID: ${{ secrets.ITEST_AWS_ROUTE53_ZONE_ID }}
          ITEST_AWS_DEBIAN12_AMI_ID: ${{ secrets.ITEST_AWS_DEBIAN12_AMI_ID }}
          ITEST_AWS_SSH_PUBKEY_1: ${{ secrets.AWS_SSH_PUBKEY_1 }}
          ITEST_AWS_SSH_PUBKEY_2: ${{ secrets.AWS_SSH_PUBKEY_2 }}

      - name: Run isetup (Deploy and setup with SSH retry)
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Deploy and Setup with SSH Retry"
            STATUS: "Pending"

          # Start retry logic
          for i in {1..10}; do
            if npm run isetup; then
              # If the setup is successful, update the comment with Success and exit loop
              uses: ./.github/workflows/update-comment.yml
              with:
                COMMENT_ID: ${{ env.COMMENT_ID }}
                STEP_NAME: "Deploy and Setup with SSH Retry"
                STATUS: "Success"
              break
            else
              # If SSH fails, log retry and update comment status as Pending
              echo "SSH authentication failed. Retrying in 10 seconds... ($i/10)"
              uses: ./.github/workflows/update-comment.yml
              with:
                COMMENT_ID: ${{ env.COMMENT_ID }}
                STEP_NAME: "Deploy and Setup with SSH Retry"
                STATUS: "Pending"
              sleep 10
            fi
          done

          # If all retries fail, update the comment with Fail and exit the job
          if [ $i -eq 10 ]; then
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Deploy and Setup with SSH Retry"
              STATUS: "Fail"
            echo "SSH authentication failed after 10 attempts. Exiting."
            exit 1
          fi

      - name: Wait for 30 seconds
        run: sleep 30

      - name: Run itest (Testing)
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Testing ephemeral"
            STATUS: "Pending"

          # Run the test command
          if npm run itest ephemeral; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Testing ephemeral"
              STATUS: "Success"
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Testing ephemeral"
              STATUS: "Fail"
            exit 1
          fi

      - name: Run setup configure (with test)
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Setup Configure Test"
            STATUS: "Pending"

          # Run the setup command
          if npm run itest setup; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Setup Configure Test"
              STATUS: "Success"
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Setup Configure Test"
              STATUS: "Fail"
            exit 1
          fi

      - name: Wait for 30 seconds
        run: sleep 30

      - name: Run account create test
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Account Create Test"
            STATUS: "Pending"

          # Run the account create test command
          if npm run itest create; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Account Create Test"
              STATUS: "Success"
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Account Create Test"
              STATUS: "Fail"
            exit 1
          fi

      - name: Run anonymous test
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Anonymous Test"
            STATUS: "Pending"

          # Run the anonymous test command
          if npm run itest anonymous; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Anonymous Test"
              STATUS: "Success"
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Anonymous Test"
              STATUS: "Fail"
            exit 1
          fi

      - name: Run settings test
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Settings Test"
            STATUS: "Pending"

          # Run the settings test command
          if npm run itest settings; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Settings Test"
              STATUS: "Success"
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Settings Test"
              STATUS: "Fail"
            exit 1
          fi

      - name: Run docker test
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Docker Test"
            STATUS: "Pending"

          # Run the docker test command
          if npm run itest docker; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Docker Test"
              STATUS: "Success"
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Docker Test"
              STATUS: "Fail"
            exit 1
          fi

      - name: Run idp-local test
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "IDP Local Test"
            STATUS: "Pending"

          # Run the idp-local test command
          if npm run itest local; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "IDP Local Test"
              STATUS: "Success"

          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "IDP Local Test"
              STATUS: "Fail"
            exit 1
          fi

      - name: Run idp-apikey test
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "IDP API Key Test"
            STATUS: "Pending"

          # Run the idp-apikey test command
          if npm run itest apikey; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "IDP API Key Test"
              STATUS: "Success"            
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "IDP API Key Test"
              STATUS: "Fail"  
            exit 1
          fi

      - name: Run idp-mrt test
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "IDP MRT Test"
            STATUS: "Pending" 

          # Run the idp-mrt test command
          if npm run itest mrt; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "IDP MRT Test"
              STATUS: "Success" 
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "IDP MRT Test"
              STATUS: "Fail" 
            exit 1
          fi

      - name: Run crypto test
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Crypto Test"
            STATUS: "Pending"           

          # Run the crypto test command
          if npm run itest crypto; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Crypto Test"
              STATUS: "Success"             
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Crypto Test"
              STATUS: "Fail" 
            exit 1
          fi

      - name: Run kv test
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "KV Test"
            STATUS: "Pending"           

          # Run the kv test command
          if npm run itest kv; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "KV Test"
              STATUS: "Success"             
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "KV Test"
              STATUS: "Fail"             
            exit 1
          fi

      - name: Run idestroy (Destroy resources)
        run: |
          # Update comment with Pending status for this step
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Destroy Resources"
            STATUS: "Pending"             

          # Run the idestroy command
          if npm run idestroy; then
            # If successful, update the comment with Success
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Destroy Resources"
              STATUS: "Success"
          else
            # If failed, update the comment with Fail
            uses: ./.github/workflows/update-comment.yml
            with:
              COMMENT_ID: ${{ env.COMMENT_ID }}
              STEP_NAME: "Destroy Resources"
              STATUS: "Fail"
            exit 1
          fi

      - name: Final Status Update
        run: |
          # Determine the final status based on the workflow result
          if [ "${{ job.status }}" == "success" ]; then
            FINAL_STATUS="Success"
          else
            FINAL_STATUS="Fail"
          fi

          # Call the update_comment function to update the final status
          uses: ./.github/workflows/update-comment.yml
          with:
            COMMENT_ID: ${{ env.COMMENT_ID }}
            STEP_NAME: "Final Status"
            STATUS: "$FINAL_STATUS"